--[[	掉落系统 	周长沙	2012-3-9--]]_G.CDropSystem = {}----------------------------------------------function CDropSystem:new()	local obj = CSystem:new("CDropSystem");	for i,v in pairs(CDropSystem) do		if type(v) == "function" then			obj[i] = v;		end;	end;	obj.CanSeeItem = {}	obj.AddList = {}	obj.DelList = {}	return obj;endfunction CDropSystem:Create()	self.CanSeeItem = {}	self.AddList = {}	self.DelList = {}	self.dwDelay = MapInfoConfig.dwTimeMon	self.dwLastTime = 0	return trueendfunction CDropSystem:Update(dwInterval)	local Add = {}	local Del = {}	local bNeedSend = false	if #self.AddList > 0 then		for i=1,10 do			local Item = self.AddList[1]			table.remove(self.AddList,1)			if Item then				Add[Item:GetObjId()] = Item:GetSendInfo()				bNeedSend = true			end		end	end	if #self.DelList > 0 then		Del = self.DelList		self.DelList = {}		--local dwObjId = self.DelList[1]		--table.remove(self.DelList,1)		--table.insert(Del,dwObjId)		bNeedSend = true	end	if bNeedSend then		local objPlayer = self:GetPlayer()		objPlayer.DropGetAllItemInfoMsg{Add=Add;Del=Del}	else		if self.Node then			CDriverManager:DelDriver(self.Node)			self.Node = nil		end	end	return trueendfunction CDropSystem:Destroy()	if self.Node then		CDriverManager:DelDriver(self.Node)	end	return trueendfunction CDropSystem:Clear()	self.CanSeeItem = {}end--------------------------------------------------系统接口--------------------------------------------------怪物掉落经验function CDropSystem:DropExp(dwMonsterExp,dwMonsterLevel,IsDupl)	--玩家对象	local objPlayer = self:GetPlayer()	if not objPlayer then return end	--防沉迷	local dwAddicted = objPlayer:GetAddicted() or 1	--组队系统	local sysTeam = objPlayer:GetSystem("CTeamSystem");	--地图系统	local sysMap = objPlayer:GetSystem("CMapSystem");		local sysPet = objPlayer:GetSystem("CPetSystem");		local dwTeamLevel = objPlayer:GetLevel()	local dwMyLevel = objPlayer:GetLevel()	local dwTeamMemberNum = 1	local dwMonsterExp = dwMonsterExp	local dwMonsterLevel = dwMonsterLevel	local bIsVip = objPlayer:GetSystem("CVipSystem"):IsVip()	if sysTeam:GetTeamId() then 		dwTeamMemberNum = 0		dwTeamLevel = objPlayer:GetSystem("CTeamSystem"):GetTeamMembersLevel()		for _,dwRoleID in pairs(objPlayer:GetSystem("CTeamSystem"):GetTeamLeaguer()) do			if sysMap:GetRoleByID(dwRoleID) then				dwTeamMemberNum = dwTeamMemberNum + 1			end		end	end		local dwExp = 0;	--如果组队模式为正常模式, 或者没有队伍	if sysTeam:GetTeamMode() or not sysTeam:GetTeamId() then		dwExp = DropFunctionConfig:GetExpInTeam(dwTeamLevel,dwMyLevel,dwTeamMemberNum,dwMonsterExp,dwMonsterLevel,bIsVip)	else		local expTbl = DropFunctionConfig:GetExpInTeamShare(objPlayer, dwTeamLevel, dwMonsterExp, dwTeamMemberNum, dwMonsterLevel);		dwExp = expTbl[objPlayer:GetRoleID()];		for dwRoleID, dwExpValue in pairs(expTbl) do			if dwRoleID ~= objPlayer:GetRoleID() then				local player = sysMap:GetRoleByID(dwRoleID)				if player then					player:GetSystem("CDropSystem"):ComputeExp(dwExpValue, dwMonsterLevel, IsDupl, dwTeamMemberNum)				end;			end;		end;	end;	local Vip = 0;	if bIsVip == true then		Vip = ExpIntegrateConfig.VipExp/100;	end		--组队加层	local team = ( dwTeamMemberNum * 0.05-0.05)	--宠物被动技能加成	local pet = (sysPet:GetPetSikllSystem().PassivitySkill:GetPetPassivitySkillAddAttriAdv(sysPet:GetOutPetEnumId()).AddExpPre) / 100;	-- print("CDropSystem:DropExp=============pet per is ",pet)		--微端加成	local mic = 0	if objPlayer:GetSystem("CScriptSystem"):IsMic() then		mic = 0.1	end		--经书经验加成	local Book = objPlayer:GetSystem("CPracticeSystem"):GetAddExpParam()	--经验丹的效果	local dwExpUp = objPlayer:GetSystem("CSkillSystem"):GetInfo().dwExpUp;		--筑长城活动经验加成	local Wall = dwExp * (CBuildRampartMgr:GetBuildExp()-1)	local Cross = dwExp *  (CCrossSvrHoldManager:GetCrossExp()-1);	dwExpUp = (dwExp * (1 + dwExpUp + Vip + team + pet + mic)) + (dwExp * ((CMovementSystemMgr:GetMRoleAddExp() or 1)-1 + Book) + Wall + Cross)		--添加活动加成率	objPlayer:AddExp(math.floor(dwExpUp*dwAddicted),CMovementSystemMgr:GetMovementExp(math.floor(dwExp*dwAddicted)))	--add by lkj 2012-04-13 用于给坐骑系统加经验	local mountSystem = objPlayer:GetSystem("CMountSystem");	if mountSystem then		--添加活动加成率		mountSystem:AddExp(math.floor(dwMonsterExp*dwAddicted*(CMovementSystemMgr:GetMountAddExp() * 1)), dwMonsterLevel);	end;	if IsDupl then		local sysDupl = objPlayer:GetSystem("CDuplSystem")		sysDupl:SetKillExp(math.floor(dwExpUp*dwAddicted))	end;endfunction CDropSystem:ComputeExp(dwExp, dwMonsterLevel, IsDupl, dwTeamMemberNum)	--玩家对象	local objPlayer = self:GetPlayer()	if not objPlayer then return end	--防沉迷	local dwAddicted = objPlayer:GetAddicted() or 1	--组队系统	local sysTeam = objPlayer:GetSystem("CTeamSystem");	--地图系统	local sysMap = objPlayer:GetSystem("CMapSystem");		local sysPet = objPlayer:GetSystem("CPetSystem");		local Vip = 0;	if bIsVip == true then		Vip = 0.2	end	if sysPet:GetOutPetObject() then		sysPet:GetOutPetObject():AddExp(dwExp)	end;	--组队加层	local team = ( dwTeamMemberNum * 0.05-0.05)	--宠物被动技能加成	local pet = (sysPet:GetPetSikllSystem().PassivitySkill:GetPetPassivitySkillAddAttriAdv(sysPet:GetOutPetEnumId()).AddExpPre) / 100;	-- print("CDropSystem:DropExp=============pet per is ",pet)		--微端加成	local mic = 0	if objPlayer:GetSystem("CScriptSystem"):IsMic() then		mic = 0.1	end		--经书经验加成	local Book = objPlayer:GetSystem("CPracticeSystem"):GetAddExpParam()	--经验丹的效果	local dwExpUp = objPlayer:GetSystem("CSkillSystem"):GetInfo().dwExpUp;		--筑长城活动经验加成	local Wall = dwExp * (CBuildRampartMgr:GetBuildExp()-1)	local Cross = dwExp *  (CCrossSvrHoldManager:GetCrossExp()-1);	dwExpUp = (dwExp * (1 + dwExpUp + Vip + team + pet + mic)) + (dwExp * ((CMovementSystemMgr:GetMRoleAddExp() or 1)-1 + Book) + Wall + Cross)	--添加活动加成率	objPlayer:AddExp(math.floor(dwExpUp*dwAddicted),CMovementSystemMgr:GetMovementExp(math.floor(dwExp*dwAddicted)))	local mountSystem = objPlayer:GetSystem("CMountSystem");	if mountSystem then		--添加活动加成率		mountSystem:AddExp(math.floor(dwExp*dwAddicted*(CMovementSystemMgr:GetMountAddExp() * 1)), dwMonsterLevel);	end;	if IsDupl then		local sysDupl = objPlayer:GetSystem("CDuplSystem")		sysDupl:SetKillExp(math.floor(dwExpUp*dwAddicted))	end;end;--怪物死亡增加铁布衫经验function CDropSystem:AddClothExp(dwMonsterExp)	--玩家对象	local objPlayer = self:GetPlayer()	if not objPlayer then return end	local crossSystem = objPlayer:GetSystem("CCrossSvrSystem");	if crossSystem:GetEnterCrossId() == 0 then		--铁布衫系统		local sysTieBuShan = objPlayer:GetSystem("CTieBuShanSystem");		sysTieBuShan:AddProgressValue(dwMonsterExp);	end;end;--怪物死亡增加玩家霸体值function CDropSystem:AddClothForbidValue(dwMonsterForbidValue)	local objPlayer = self:GetPlayer()	if not objPlayer then return end	local crossSystem = objPlayer:GetSystem("CCrossSvrSystem");	if crossSystem:GetEnterCrossId() == 0 then		--铁布衫系统		local sysTieBuShan = objPlayer:GetSystem("CTieBuShanSystem");		sysTieBuShan:AddForbidValue(dwMonsterForbidValue);	end;end;--检查玩家能否拾取某个物品function CDropSystem:CheckForGet(Item)	--玩家对象	local objPlayer = self:GetPlayer()	if not objPlayer then return end	--物品绑定的道具信息	local ItemInfo = Item:GetItem()	--物品的归属玩家	local dwRoleId = Item:GetRoleId()	local dwMyRoleId = objPlayer:GetInfo().dwRoleID	if dwRoleId and dwRoleId~=0 and dwRoleId~= dwMyRoleId then		if not CConfig.bIsCrossSvr then			--组队系统			local sysTeam = objPlayer:GetSystem("CTeamSystem");			if sysTeam:GetTeamId() then				local Team = sysTeam:GetTeamLeaguer();				local IsMyTeamItem = false				for k,v in pairs(Team) do					if v == dwRoleId then						IsMyTeamItem = true					end				end				if not IsMyTeamItem then					--不能拾取别人的物品					self:SendPickErrorInfo(Item:GetObjId(),1)					return false				end			else				--不能拾取别人的物品				self:SendPickErrorInfo(Item:GetObjId(),1)				return false			end		else			--不能拾取别人的物品			self:SendPickErrorInfo(Item:GetObjId(),1)			return false		end				return true	end	--物品系统	local sysItem = objPlayer:GetSystem("CItemSystem");	--道具id	local dwItemEnum = ItemInfo.dwItemEnum		if dwItemEnum == DropFunctionConfig:GetMoneyId() then		return true	end	return trueend--------------------------------------------------消息接收--------------------------------------------------切换格子function CDropSystem:OnChangeMapCheckerEX(setOldChecker,setNewChecker)	self:SendMapItemInfo()endfunction CDropSystem:OnChangeMapChecker(setOldID,setNewID)	self:SendMapItemInfo()end--收到玩家拾取某个物品的消息function CDropSystem:OnRecvPickItem(dwObjId)	--local Item = CDropManager:GetItem(dwObjId)	--玩家对象	local objPlayer = self:GetPlayer();	if not objPlayer then return end	--地图对象	local objMap = objPlayer:GetSystem("CMapSystem"):GetCurMap()	--物品信息	local Item = objMap:GetItemByObjID(dwObjId)	--如果物品不存在	if not Item then		return -1	end	--检查玩家能否拾取某个物品	if self:CheckForGet(Item) then		--物品系统		local sysItem = objPlayer:GetSystem("CItemSystem");		--物品绑定的道具信息		local ItemInfo = Item:GetItem()		--道具id		local dwItemEnum = ItemInfo.dwItemEnum		--如果该道具是金钱		if dwItemEnum == DropFunctionConfig:GetMoneyId() then			local sysItem = objPlayer:GetSystem("CItemSystem");			--组队系统			local sysTeam = objPlayer:GetSystem("CTeamSystem");			--如果玩家在队伍里			if sysTeam:GetTeamId() then				local Team = sysTeam:GetTeamLeaguer();				local sysMap = objPlayer:GetSystem("CMapSystem")				for k,v in pairs(Team) do					local objPlayer = sysMap:GetRoleByID(v)					--quying chg 2012-04-28					if objPlayer then						local sysItem = objPlayer:GetSystem("CItemSystem");						local dwTeamLevel = objPlayer:GetSystem("CTeamSystem"):GetTeamMembersLevel()						local dwMyLevel = objPlayer:GetLevel()						local dwTeamMemberNum = #objPlayer:GetSystem("CTeamSystem"):GetTeamLeaguer()						local dwMonsterMoney = ItemInfo.dwNum						local dwMonsterLevel = dwMyLevel--(待改)						if (dwTeamMemberNum or 0) > 0 then							local dwMoney = DropFunctionConfig:GetMoneyInTeam(dwTeamLevel,dwMyLevel,dwTeamMemberNum,dwMonsterMoney,dwMonsterLevel)							sysItem:AddPacketMoney(dwMoney, _G.ItemSysOperType.PickUp);						end					end;				end			else				local dwTeamLevel = objPlayer:GetLevel()				local dwMyLevel = objPlayer:GetLevel()				local dwTeamMemberNum = 1				local dwMonsterMoney = ItemInfo.dwNum				local dwMonsterLevel = dwMyLevel--(待改)				local dwMoney = DropFunctionConfig:GetMoneyInTeam(dwTeamLevel,dwMyLevel,dwTeamMemberNum,dwMonsterMoney,dwMonsterLevel)				sysItem:AddPacketMoney(dwMoney, _G.ItemSysOperType.PickUp);			end		else			local addItemList = {};			local tempTable = {				dwItemEnum	= dwItemEnum;				dwItemNumber= ItemInfo.dwNum;				dwBindType	= ItemInfo.dwBindType;				dwStrongLevel=ItemInfo.dwStrong;				setProperty = CGlobalItemManager:GetPropertyByQuality(dwItemEnum, ItemInfo.dwQuality);			};			table.insert(addItemList, tempTable);			--给玩家添加物品			self:SendPickErrorInfo(Item:GetObjId(),0)			sysItem:AddEnumItemListToPacket(addItemList, _G.ItemSysOperType.PickUp);						if CConfig.bIsCrossSvr then				local sysCorssSvr = objPlayer:GetSystem("CCrossSvrSystem");				local objCrossSvr = sysCorssSvr:GetCrossObj();				local honorValue = CrossSvrNpcShopConfig.HonorList[dwItemEnum];				if honorValue then					local dwRoleID = objPlayer:GetRoleID()					objCrossSvr:SetHonorById(dwRoleID, honorValue);                    CCSKillChartSystemManager:Trigger(objPlayer);				end			end		end		--删除地图上的物品		objMap:GetDropMgr():Remove(dwObjId)		return true	else		return -2	endend--------------------------------------------------消息发送--------------------------------------------------发送全地图物品信息function CDropSystem:SendMapItemInfo()	local Add = {}	local Del = {}	local objPlayer = self:GetPlayer();	local objMap = objPlayer:GetSystem("CMapSystem"):GetCurMap()	local Items = objMap:GetCanLookDroper(objPlayer)	for k,v in pairs(Items) do		if not self.CanSeeItem[k] then			self.CanSeeItem[k] = v:GetSendInfo()			--Add[k] = self.CanSeeItem[k]			table.insert(self.AddList,v)		end	end	for k,v in pairs(self.CanSeeItem) do		if not Items[k] then			self.CanSeeItem[k] = nil			--table.insert(Del,k)			table.insert(self.DelList,k)		end	end	if self.Node then		CDriverManager:DelDriver(self.Node)	end	self.Node = CDriverManager:AddDriver(eInterval._100ms_a,self,CDropSystem.Update)	--objPlayer.DropGetAllItemInfoMsg{Add=Add;Del=Del};end--发送拾取出错信息function CDropSystem:SendPickErrorInfo(dwObjId,dwErrorType)	local objPlayer = self:GetPlayer();	objPlayer.DropPickErrorInfoMsg{ObjId=dwObjId,DwErrorType=dwErrorType}end