--[[	掉落系统 单体管理器	周长沙	2012-3-9--]]--------------------------------_G.CDropManager = {}----------------------------------构造function CDropManager:new(Map)	local obj = {}	--保存地图对象	obj.Map = Map	for k,v in pairs(CDropManager) do		if type(v)=="function" then			obj[k]=v		end	end	return obj;end--初始化function CDropManager:Create()	self.Nodes = {}--[dwObjId]={Item=Node;dwTime=_now()};	self.dwCount = 0	self.dwDelay = 1000	self.dwLastUpdateTime = 0	self.dwKeepTime = 60000--1分钟后清归属权	self.dwItemLastTime = 120000--2分钟后消失	------------------------------------------------------------------------	return trueend--更新 服务器的逻辑function CDropManager:Update()	local dwNowTime = GetCurTime()	if dwNowTime-self.dwLastUpdateTime>self.dwDelay then		self.dwLastUpdateTime = dwNowTime		for dwObjId,Info in pairs(self.Nodes) do			if dwNowTime-Info.dwTime >self.dwKeepTime and Info.Item.dwRoleId and Info.Item.dwRoleId~=0 then				Info.Item:ClearRoleId()			end			if dwNowTime-Info.dwTime >self.dwItemLastTime then				self:Remove(Info.Item:GetObjId())			end		end	end	return trueend--销毁function CDropManager:Destroy()	return trueend---------------------------------------插入一个物品信息到管理器function CDropManager:Insert(Node)	if not Node.ObjId then		self.dwCount = self.dwCount + 1		Node:SetObjId(self.dwCount)	end	self.Nodes[Node:GetObjId()] = {Item=Node;dwTime=GetCurTime()};	self:GetItem(Node:GetObjId()):Show(self.Map)	-- local dwCheckerX,dwCheckerY = CCheckerManager:GetCurChecker(self.Map,Node:GetPos().x,Node:GetPos().y)	-- Node.dwCheckerX = dwCheckerX	-- Node.dwCheckerY = dwCheckerY	-- self.Map.setChecker[dwCheckerX][dwCheckerY]:AddDroper(Node)	-- CCheckerManager:InitCanSeeEntity(self.Map,Node.setCanSeeEntity,dwCheckerX,dwCheckerY)	return Node:GetObjId()end--新建一个物品function CDropManager:Add(fPosX,fPosY,dwRoleId,Item,Monster)	local Node = CDrop:new(fPosX,fPosY,dwRoleId,Item,Monster)	return self:Insert(Node)end--移除一个物品function CDropManager:Remove(ObjId)	local Item = self:GetItem(ObjId)	if Item then	--	print('Item.dwCheckerX =',Item.dwCheckerX,'Item.dwCheckerY =',Item.dwCheckerY)		--self.Map.setChecker[Item.dwCheckerX][Item.dwCheckerY]:DelDroper(ObjId)		Item:Hide(self.Map)		self.Nodes[ObjId] = nil	endend-- 清理所有掉落function CDropManager:RemoveAll()	for k, _ in pairs(self.Nodes) do		self:Remove(k);	endend--根据物品对象id获得一个物品function CDropManager:GetItem(ObjId)	if self.Nodes[ObjId] then		return self.Nodes[ObjId].Item	end	return nilend--获得所有物品信息function CDropManager:GetAllItem()	return self.Nodesend----------------------------------------执行掉落function CDropManager:DropDx(Items,dwNow,dy,dwStart,dwEnd,dwStep,dwRoleId,Monster)	local pos = Monster:GetVectorPos()	for dx=dwStart,dwEnd,dwStep do		self:Add(pos.x+dx,pos.y+dy,dwRoleId,Items[dwNow],Monster)		dwNow = dwNow + 1		if dwNow>#Items then			return nil;		end	end	return dwNowendfunction CDropManager:DropDy(Items,dwNow,dx,dwStart,dwEnd,dwStep,dwRoleId,Monster)	local pos = Monster:GetVectorPos()	for dy=dwStart,dwEnd,dwStep do		self:Add(pos.x+dx,pos.y+dy,dwRoleId,Items[dwNow],Monster)		dwNow = dwNow + 1		if dwNow>#Items then			return nil;		end	end	return dwNowend----------------------------------------触发某只怪物的掉落function CDropManager:DoDrop(Monster,objPlayer)	local dwRoleId = objPlayer:GetRoleID()	local dwMonsterId = Monster:GetID()	local dwDropId,dwDropExId = Monster:GetDropId()	local ItemInfo = CDropControl:DoDrop(dwDropId,dwRoleId,objPlayer:GetAddicted())	local Items = {}	--local sysTask = objPlayer:GetSystem("CTaskSystem");		--脚本额外掉落	if dwDropExId then		local ItemInfoEx = CDropControl:DoDrop(dwDropExId,dwRoleId,objPlayer:GetAddicted())		for k,v in pairs(ItemInfoEx) do			table.insert(ItemInfo,v)		end		Monster.dwExDropId = nil	end		--活动掉落	local ExDrop = CDropControlEx:Check(Monster)	for k,v in pairs(ExDrop) do		local ItemInfoEx = CDropControlEx:DoDrop(v,dwRoleId,objPlayer:GetAddicted())		for k,v in pairs(ItemInfoEx) do			table.insert(ItemInfo,v)		end	end		--检查掉落是任务掉落还是普通掉落	for k,v in pairs(ItemInfo) do		--品质特殊处理		if v.dwQuality and v.dwQuality==0 then			local ConfigInfo = EquipBaseData[v.dwItemEnum] or OtherBaseData[v.dwItemEnum] or {}			ItemInfo[k].dwQuality = ConfigInfo.dwQuality or 0		end				if not CConfig.bIsCrossSvr then			--任务掉落			if v.dwTaskId and v.dwTaskId~=0 then				objPlayer:GetSystem("CTaskSystem"):DoDrop(v)			--普通掉落			else				table.insert(Items,ItemInfo[k])			end		else			--普通掉落			table.insert(Items,ItemInfo[k])		end	end		--执行普通掉落	if #Items > 0 then		--print("drop num",#Items)		--local objPlayer = CGameLineManager:GetPlayer(dwRoleId)		objPlayer:GetSystem("CPlayerEventCenterSystem"):DoEvent(enumPlayerEventType.EventDrop,1);		local dwNow = 1		local pos = Monster:GetVectorPos()		local d = 2		local dx,dy = 0,0		while not (dwNow>#Items) do			d = d/2			for i=1,20,d do				dy=i				dwNow = self:DropDx(Items,dwNow,dy,-i+1,i,d,dwRoleId,Monster)				if not dwNow then return end;				dx=i				dwNow = self:DropDy(Items,dwNow,dx,i-1,-i,-d,dwRoleId,Monster)				if not dwNow then return end;				dy=-i				dwNow = self:DropDx(Items,dwNow,dy,i-1,-i,-d,dwRoleId,Monster)				if not dwNow then return end;				dx=-i				dwNow = self:DropDy(Items,dwNow,dx,-i+1,i,d,dwRoleId,Monster)				if not dwNow then return end;			end		end	endend