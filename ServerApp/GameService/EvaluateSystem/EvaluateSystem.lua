--[[功能：评价系统类（服务器）版本：v1.0作者：郭肇义时间：2012-04-05]]_G.CEvaluateSystem = {};function CEvaluateSystem:new()	local obj = CSystem:new("CEvaluateSystem");		for index, value in pairs(CEvaluateSystem) do		if type(value) == "function" then			obj[index] = value;		end;	end;	return obj;end;---------------------------------------------------------------------------------------------function CEvaluateSystem:Create()	local objPlayer = self:GetPlayer();	if not objPlayer then		_err("CEvaluateSystem Create Cannot get player");		return false;	end;	local tbData = objPlayer:GetLineData("CEvaluateSystem")[1]	self.dwUpdate,self.dwEvaluate,self.tbEvaluate = 0,0,{}	if tbData then		self.dwUpdate = tbData.dwUpdate		self.tbEvaluate = self:DecodeEvaluate(tbData.szEvaluate)		for k,v in pairs(self.tbEvaluate) do			self.dwEvaluate = self.dwEvaluate + 1		end	else		local objQuery = objPlayer:GetDBQuery()		local SqlCmd = objQuery:CreateInsertCmd('T_Role_Evaluate_Send_New')		SqlCmd.Fields.szEvaluate = ""		SqlCmd.Fields.dwUpdate = 0		SqlCmd.Wheres.dwRoleID = self:GetPlayer():GetRoleID()		SqlCmd:execute()	end	return true;end;function CEvaluateSystem:Update(dwInterval)	return true;end;function CEvaluateSystem:Destroy()end;function CEvaluateSystem:OnChangeLineBegin()	local tbData = {}	tbData.dwUpdate = self.dwUpdate	tbData.szEvaluate = self:EncodeEvaluate(self.tbEvaluate)	self:GetPlayer():SetLineData("CEvaluateSystem",tbData)end;-----------------------------------------------------------------------------------------------接口---------------------------------------------------------------------------------------------function CEvaluateSystem:GetEvaluate()	local tbInfo = {}	tbInfo.dwUpdate = self.dwUpdate	tbInfo.tbEvaluate = self.tbEvaluate	return tbInfoendfunction CEvaluateSystem:AddEvaluate(dwRoleID,eType)	local objPlayer = self:GetPlayer();	local sysItem = objPlayer:GetSystem('CItemSystem')	local dwItemEnum = 0	if eType == 0 then dwItemEnum = EvaluateConfig.dwFlowerEnum end	if eType == 1 then dwItemEnum = EvaluateConfig.dwEggEnum end	local dwItemNumber = sysItem:GetEnumItemNumInPacket(dwItemEnum)	if dwItemNumber <= 0 then return end	if not CTimeFormat:isToday(self.dwUpdate) then		self.tbEvaluate,self.dwEvaluate = {},0	end	local dwMaxEvaluate = EvaluateConfig.dwMaxEvaluate	if self.dwEvaluate >= dwMaxEvaluate then return end	if self.tbEvaluate[dwRoleID] then return end		sysItem:DelEnumItemInPacket(dwItemEnum,1,false,ItemSysOperType.Used)	self.tbEvaluate[dwRoleID],self.dwEvaluate = true,self.dwEvaluate + 1	self.dwUpdate = GetCurTime()	local dwAddExp = EvaluateConfig.AddExp(objPlayer:GetLevel())	objPlayer:AddExp(dwAddExp)	objPlayer.OnAddEvaluateMsg{}		local objQuery = objPlayer:GetDBQuery()	local SqlCmd = objQuery:CreateUpdateCmd('T_Role_Evaluate_Send_New')	SqlCmd.Fields.szEvaluate = self:EncodeEvaluate(self.tbEvaluate)	SqlCmd.Fields.dwUpdate = self.dwUpdate	SqlCmd.Wheres.dwRoleID = objPlayer:GetRoleID()	SqlCmd:execute()		CKernelApp.KSAddEvaluateMsg{ RoleID = dwRoleID,Type = eType }	return { dwAddExp = dwAddExp }end-----------------------------------------------------------------------------------------------私有---------------------------------------------------------------------------------------------function CEvaluateSystem:EncodeEvaluate(tbInfo)	local szText = ""	for dwRoleID in pairs(tbInfo) do		szText = szText..dwRoleID..'#'	end	return szTextendfunction CEvaluateSystem:DecodeEvaluate(szText)	local tbInfo = {}	local dwLast,dwNext = 0,string.find(szText,'#')	while(dwNext) do		local dwRoleID = tonumber(string.sub(szText,dwLast+1,dwNext-1))		tbInfo[dwRoleID] = true		dwLast,dwNext = dwNext,string.find(szText,'#',dwNext+1)	end	return tbInfoend---------------------------------------------------------------------------------------------