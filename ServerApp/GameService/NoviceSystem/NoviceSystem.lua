--[[功能：新手引导系统类（服务器）版本：v1.0作者：郭肇义时间：2012-03-22]]_G.CNoviceSystem = {};function CNoviceSystem:new()	local obj = CSystem:new("CNoviceSystem");		for index, value in pairs(CNoviceSystem) do		if type(value) == "function" then			obj[index] = value;		end;	end;	return obj;end;-----------------------------------------------------------------------------------------------------------------------------------------------function CNoviceSystem:Create(IsChangeLine)	--获取Player	local objPlayer = self:GetPlayer();	if not objPlayer then		_err("CNoviceSystem Create Cannot get player");		return false;	end;	--初始化DB	local objDB = objPlayer:GetDBQuery();	if not objDB then		_err("CNoviceSystem Create Cannot get DBQuery");		return false;	end;	self.objDBQuery = CNoviceSystemDB:new(objDB, self);	--获得已完成引导	local tabDataList = objPlayer:GetLineData("CNoviceSystem")	self.tabFinishedEventList = tabDataList[1] or {}		--初始化服务器事件	self.objEventManager = CNoviceEventManager:new(self)	self.tabEventList = {}	local tabUnfinishedGuideList  = {}	for k,v in pairs(NoviceGuideConfig) do		if not self:IsFinishedGuide(k) then			tabUnfinishedGuideList[k] = v		end	end	local tabEventIndexList = { 'dwStartEventId','dwEndEventId','dwTerminateEventId' }	for k,v in pairs(tabUnfinishedGuideList) do		for _,index in pairs(tabEventIndexList) do			local dwEventId = v[index]			if not dwEventId then			elseif type(dwEventId) == 'number' then				self.objEventManager:CreateEvent(k,dwEventId)			elseif type(dwEventId) == 'table' then				for _,id in pairs(dwEventId) do					self.objEventManager:CreateEvent(k,id)				end			end		end	end	return true;end;function CNoviceSystem:Update(dwInterval)	return true;end;function CNoviceSystem:Destroy()end;function CNoviceSystem:OnChangeLineBegin(dwNewLineID)	local objPlayer = self:GetPlayer()	objPlayer:SetLineData("CNoviceSystem",self.tabFinishedEventList)end-------------------------------------------------------------------------------------------------------------------------------------------------客户端请求响应-------------------------------------------------------------------------------------------------------------------------------------------------获取已触发引导function CNoviceSystem:GetFinishedNoviceGuideList()	return self.tabFinishedEventListend--注册引导完成function CNoviceSystem:RegisterNoviceGuideFinished(dwGuideId)	if self:IsValidGuide(dwGuideId) then		if not self:IsFinishedGuide(dwGuideId) then			table.insert(self.tabFinishedEventList,dwGuideId)			self.objDBQuery:AddFinishedGuide(dwGuideId)			self:Unregister(dwGuideId)		end	endend-------------------------------------------------------------------------------------------------------------------------------------------------事件中心回调函数-----------------------------------------------------------------------------------------------------------------------------------------------function CNoviceSystem:OnEventCenter(szEvent,...)	if not self.tabEventList then return end	local tabEventList = self.tabEventList[szEvent]	if not tabEventList then return end	for k,v in pairs(tabEventList) do		if v:Check(...) then			v:Notify(...)		end	endend-------------------------------------------------------------------------------------------------------------------------------------------------私有函数-----------------------------------------------------------------------------------------------------------------------------------------------function CNoviceSystem:IsValidGuide(dwGuideID)	local bFlag = false	for dwIndex in pairs(NoviceGuideConfig) do		if dwIndex == dwGuideID then			bFlag = true		end	end	return bFlagendfunction CNoviceSystem:IsFinishedGuide(dwGuideID)	local bFlag = false	for _,dwValue in pairs(self.tabFinishedEventList) do		if dwValue == dwGuideID then			bFlag = true		end	end	return bFlagendfunction CNoviceSystem:Register(szEvent,objEvent)	local tabEventList = self.tabEventList[szEvent] or {}	table.insert(tabEventList,objEvent)	self.tabEventList[szEvent] = tabEventListendfunction CNoviceSystem:Unregister(dwGuideId)	for k,v in pairs(self.tabEventList) do		for dwIndex,objEvent in pairs(v) do			if objEvent.tabData.dwGuideId == dwGuideId then				v[dwIndex] = nil			end		end	endend----------------------------------------------------------------------------------