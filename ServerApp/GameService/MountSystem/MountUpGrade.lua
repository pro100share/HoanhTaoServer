--坐骑升阶function CMountSystem:UpGrade(n_MountInstID, b_IsAutoBuy,b_IsUseGold,b_IsFirstUseBind)	--检测权限	if not self:HasAuthority("Mount") then return end;		local objPlayer = self:GetPlayer();	if not objPlayer then		_err("Cannot get player by CMountSystem:UpGrade()");		return;	end;	--检查坐骑升阶条件	local mountInst = self:GetMountInst(n_MountInstID);	if not mountInst then return end;	--是否可以升阶	if not mountInst:IsCanUpGrade() then return end;	--检测升阶材料	----检测需要材料个数	------所需金钱	local n_NeedMoney	= math.ceil(_G.UpGradeConfig.NeedMoney(mountInst) * self.nDiscount_UpGrade);	if not self.ItemSystem:IsPacketMoneyEnough(n_NeedMoney) then return end;	------所需材料个数	--------所需神龙果个数	local n_NeedSLGNum	= _G.UpGradeConfig.NeedSLGNum(mountInst);	--------检测背包中是否有足够神龙果	local b_IsEnough_1, n_Minus_1 = self.ItemSystem:CheckDelEnumItemInPacketCond(_G.UpGradeConfig.GetSLGEnumID(mountInst), n_NeedSLGNum);	--------用于自动购买	local autoBuyInfo = {};	if not b_IsEnough_1 then		if b_IsAutoBuy then			local t = {};			t.dwItemEnum 	= _G.UpGradeConfig.GetSLGEnumID(mountInst);			t.dwItemNumber 	= n_Minus_1;			table.insert(autoBuyInfo, t);		else--材料不够而且不是自动购买则返回			return;		end;	end;	--------如果自动购买列表不为空则执行自动购买逻辑	if #autoBuyInfo > 0 then		local mallSystem = objPlayer:GetSystem("CMallSystem");		if not mallSystem then			_err("get mallSystem error!!!");			return;		end;		if b_IsUseGold then--			local n_Result, n_Cost = mallSystem:CanBuyItemListGold(autoBuyInfo);--			if n_Result > 0 then return end;			for k, v in pairs(autoBuyInfo) do				local buySuc = mallSystem:BuyItemByIDGold(v.dwItemNumber, v.dwItemEnum)				if not buySuc then					_err("auto buy error!!!");					return				end;			end;		else--			local n_Result, n_Cost = mallSystem:CanBuyItemListBindGold(autoBuyInfo);--			if n_Result > 0 then return end;			for k, v in pairs(autoBuyInfo) do				local buySuc = mallSystem:BuyItemByIDBindGold(v.dwItemNumber, v.dwItemEnum)				if not buySuc then					_err("auto buy error!!!");					return				end;			end;		end		--------检测背包中是否有足够神龙果		b_IsEnough_1, n_Minus_1 = self.ItemSystem:CheckDelEnumItemInPacketCond(_G.UpGradeConfig.GetSLGEnumID(mountInst), n_NeedSLGNum);		if not b_IsEnough_1 then return end;	end;	--删除各种石头和钱	----删除钱	self.ItemSystem:CostPacketMoney(n_NeedMoney, _G.ItemSysOperType.Mount);	----删除各种石头--删除物品通知	self.ItemSystem:DelEnumItemInPacket(_G.UpGradeConfig.GetSLGEnumID(mountInst), n_NeedSLGNum, b_IsFirstUseBind, _G.ItemSysOperType.Mount);	--天官赐福	local isSuc = false;    local addExp = 0;	isSuc = self.TianGuanCiFuSystem:IsMountUpGradeMax();	if not isSuc then		--成功率		local n_SuccessRate	= _G.UpGradeConfig.S_SuccessRate(mountInst, self.TianGuanCiFuSystem:Get_MountUpGrade());		if math.random(1, 10000) <= n_SuccessRate then			isSuc = true;		end;	end;	if isSuc then		local beforeName = mountInst:GetName();		local beforeQuality = mountInst:GetQuality();		-----------------		--日志记录		local dwBegin = self.TianGuanCiFuSystem:Get_MountUpGrade();		local dwEnd = 0;		CLogSystemManager:cifu(objPlayer, 1, mountInst:GetEnumID(), 1, dwBegin, dwEnd);		-----------------		mountInst:UpGrade();		if self:GetState() then			self.nShift = 0;			objPlayer:SetMount(mountInst:GetEnumID(nShift, objPlayer:GetInfo().dwProf));			self:AddMountEffect(#mountInst:GetChangeRank());		end;		local afterName = mountInst:GetName();		local afterQuality = mountInst:GetQuality();		self:InsertDirty(mountInst:GetInstID());		self.b_ImmediatelySave = true;		self.TianGuanCiFuSystem:Set_MountUpGrade(0);		if mountInst:GetInstID() == self.n_ActiveMountID then			self:AttributeChange();		end;		local playerRoleID = objPlayer:GetRoleID();		local playerName = objPlayer:GetInfo().szRoleName;		if mountInst:GetGrade() > _G.UpGradeConfig.BroadCastGrade then			CGameApp.MountSys_BroadCastUpGradeMsg{				PlayerRoleID = playerRoleID,				PlayerName = playerName,				MountInstID = mountInst:GetInstID(),				BeforeName = beforeName,				BeforeQuality = beforeQuality,				AfterName = afterName,				AfterQuality = afterQuality			};		end;		--通知事件中心		objPlayer:GetSystem('CPlayerEventCenterSystem'):DoEvent(_G.enumPlayerEventType.EventMountUpGrade,1, mountInst:GetGrade());	else        --增加天官赐福		self.TianGuanCiFuSystem:Add_MountUpGrade(mountInst);        --加经验        local addExpNum = objPlayer:GetSystem("CRefreshSystem"):GetData(0103);		if addExpNum and addExpNum > 0 then            addExp = _G.UpGradeConfig.AddExp(mountInst, objPlayer:GetLevel());			objPlayer:AddExp(addExp);			objPlayer:GetSystem("CRefreshSystem"):SetData(0103,addExpNum - 1);		end;	end;	objPlayer.MountSys_UpGradeResultMsg{MountInstID = mountInst:GetInstID(), IsSuc = isSuc, AddExp = addExp};end;--设置升阶折扣function CMountSystem:SetDisCount_UpGrade(value)	self.nDiscount_UpGrade = value;end;