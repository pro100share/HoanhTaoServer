--[[功能：服务器大事件系统类（服务器）版本：v1.0作者：粟宇征时间：2012-12-05]]_G.CServerEventSystem = {};--m_tabData				--大事件数据--m_dwEventID			--事件IDfunction CServerEventSystem:new()	local obj = CSystem:new("CServerEventSystem");	obj.ItemSystem = nil;	for index, value in pairs(CServerEventSystem) do		if type(value) == "function" then			obj[index] = value;		end;	end;	return obj;end;----------------------------------------------------------------------------------------------------function CServerEventSystem:Create()	--获得player	local objPlayer = self:GetPlayer();	if not objPlayer then		_err("CServerEventSystem Create Cannot get player");		return false;	end;		local Data1 = objPlayer:GetLineData("CServerEventSystem");	local Data2 = objPlayer:GetLineData("CServerEventSystem_KS");		--初始化数值	self.m_tabData = {};	self.m_dwEventID = 0;		return true;end;function CServerEventSystem:Update(dwInterval)	return true;end;function CServerEventSystem:Destroy()end;------------------------------------------------------------------------------------------------------设置数据function CServerEventSystem:SetSeverEventData(tabData)	self.m_tabData = tabData or {};end--换线处理function CServerEventSystem:OnChangeLineBegin(dwNewLineID)	self:GetPlayer():SetLineData("CServerEventSystem",self.m_tabData)	local tab = {};	tab.dwEventID = self.m_dwEventID;	self:GetPlayer():SetLineData("CServerEventSystem_KS",tab)	end--获取所有事件function CServerEventSystem:GetSeverEventData()	local tAllData = {}	local dwNum = 1;	for i = 1,_G.dwServerEventTypeNum do		local tabTemp = self.m_tabData[i]; 		for k,v in ipairs(tabTemp or {}) do			tAllData[dwNum] = {}			tAllData[dwNum].eEventType = v.eEventType			tAllData[dwNum].dwCompleteRoleID = v.dwCompleteRoleID			if tAllData[dwNum].dwRoleID ~= -1 then				tAllData[dwNum].szCompleteRoleName = v.szCompleteRoleName			else				tAllData[dwNum].szCompleteRoleName = ' '			end			tAllData[dwNum].dwCompleteTime = v.dwCompleteTime			tAllData[dwNum].dwData1 = v.dwData1			tAllData[dwNum].szData1 = v.szData1			tAllData[dwNum].dwEventID = v.dwEventID			dwNum = dwNum + 1;		--	table.insert( tAllData, tabData );		end	end	return tAllData;end--获取目标类型所有事件function CServerEventSystem:GetSeverEventTypeData(SeverEventType)	return self.m_tabData[SeverEventType];end--响应--所有数据function CServerEventSystem:SeverEventData()	local tabResult = self:GetSeverEventData();	self:GetPlayer().OnUpdateServerEventDataMsg{Result = tabResult or {}};end--类型数据function CServerEventSystem:SeverEventTypeData(SeverEventType)	local tabResult = self:GetSeverEventTypeData(SeverEventType);	self:GetPlayer().OnGetServerEventDataMsg{eSeverEventType = SeverEventType,tabData = tabResult or {}};end--添加一个大事件function CServerEventSystem:AddSeverEventData(Data)	if not Data.eEventType then return false end;	if Data.eEventType < 1 or Data.eEventType > _G.dwServerEventTypeNum then return false end;	if not self:ParseIsCanAdd(Data) then return false end;		--抛出事件	local objSystem = self:GetPlayer():GetSystem("CPlayerEventCenterSystem")	local szEvent = enumPlayerEventType.EventAddSeverEventComplete	objSystem:DoEvent(szEvent,Data)		--添加数据	CKernelApp.KSAddSeverEventDataMsg{ ResID = 	self:GetPlayer():GetInfo().dwRoleID,Data = Data }		self.m_dwEventID = self.m_dwEventID + 1;	Data.dwEventID = self.m_dwEventID;	local tabPlayerList = CMapManager:GetPlayer();	for dwRoleID, objPlayer in pairs(tabPlayerList) do		table.insert(objPlayer:GetSystem("CServerEventSystem"):GetSeverEventTypeData(Data.eEventType),Data)		--走马灯广播		--objPlayer.OnSucceedAddServerEventMsg {Result = Data or {}}	end	end--判断是否能添加function CServerEventSystem:ParseIsCanAdd(Data)	if not self.m_tabData then return false end	--if CMapManager:GetPlayer(Data.dwCompleteRoleID):IsGMAllowed() then return false end;		--GM权限判断	--时间不合法	if not self.m_tabData[1] then		return false	end	if not self.m_tabData[1][1] then		return false	end	if Data.dwCompleteTime - self.m_tabData[1][1].dwCompleteTime <= 0 then return false end;		local bIsCan = false;	--系统	if Data.eEventType == eSeverEventType.System then		--不能为开服数据		if Data.dwData1 ~= 0 then 			bIsCan = true;		end	end	--成就	if Data.eEventType == eSeverEventType.Achievement then		bIsCan = true;		for _,v in ipairs(self.m_tabData[eSeverEventType.Achievement]) do			if Data.dwData1 == v.dwData1 then				bIsCan = false;				break;			end		end	end	return bIsCan;end--请求添加大事件function CServerEventSystem:KSRequestAddSeverEvent(Data)	CKernelApp.KSRequestSeverEventDataMsg{ ResID = 	self:GetPlayer():GetRoleID(),Data = Data }end--监听事件触发function CServerEventSystem:OnEventCenter(szEvent,param1,param2)	if szEvent == enumPlayerEventType.EventAchievementComplete then		--加入大事件处理		if AchievementConfig[param2].tabContent.bSeverEvent then 			local tabData = {}			tabData.eEventType 	= eSeverEventType.Achievement;			local tabPlayerInfo = self:GetPlayer():GetInfo()			tabData.dwCompleteRoleID =  tabPlayerInfo.dwRoleID			tabData.szCompleteRoleName = tabPlayerInfo.szRoleName			tabData.dwData1 = param2			tabData.dwCompleteTime = GetCurTime();				self:KSRequestAddSeverEvent(tabData)		end	end	end