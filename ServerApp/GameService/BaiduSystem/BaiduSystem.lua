--百度抽奖用系统_G.CBaiduSystem = {};function CBaiduSystem:new()	local obj = CSystem:new("CBaiduSystem");		obj.setGetRecord = {};		for i,v in pairs(CBaiduSystem) do		if type(v) == "function" then			obj[i] = v;		end;	end; 	return obj;end;function CBaiduSystem:Create()	self.objPlayer = self:GetPlayer();	if not self.objPlayer then		return false;	end;	self.m_ObjDB = self.objPlayer:GetDBQuery();	if not self.m_ObjDB then		return false;	end;		local lineData = self.objPlayer:GetLineData("CBaiduSystem")[1];	self:DecodeAwardStr(lineData[1]);		return true;end;function CBaiduSystem:Destroy()	self:Save();end;function CBaiduSystem:OnChangeLineBegin()	local lineData = {};	lineData[1] = self:EncodeAwardStr();	self.objPlayer:SetLineData("CBaiduSystem", lineData);end;function CBaiduSystem:OnEnterScene()	self.objPlayer.OnPrizeStateMsg	{		Reward = self.setGetRecord;	}endfunction CBaiduSystem:Save()	local SqlCmd = self.m_ObjDB:CreateUpdateCmd("T_Role_Baidu");	SqlCmd.Fields.szParam	= self:EncodeAwardStr();	SqlCmd.Wheres.dwRoleID	= self.objPlayer:GetRoleID();	SqlCmd:execute();end;function CBaiduSystem:GetPrize(dwType)	local tbList = BaiduPrize[dwType];	if not tbList then		_err("Type Error",dwType)		return;	end		local objItemSys = self.objPlayer:GetSystem("CItemSystem");	if not objItemSys then		_err("not find itemsystem");		return;	end		if self.setGetRecord[dwType] == 1 then		return;	end			local setAddList = {};	for _, v in ipairs(tbList) do		local item = {			dwItemEnum 		= v[1],			dwItemNumber	= v[2],			dwBindType		= _G.enItemBindType.eYes,		};		table.insert(setAddList, item);	end;		if not objItemSys:AddEnumItemListToPacket(setAddList,_G.ItemSysOperType.BaiduPrize) then		self.objPlayer.OnGetResultMsg		{			Type = dwType;			Code = 0;		}		return;	end		self.setGetRecord[dwType] = 1;	self:Save();		self.objPlayer.OnGetResultMsg	{		Type = dwType;		Code = 0;	}end;function CBaiduSystem:DecodeAwardStr(str)	local lastIndex = 0;	while true do		local nextIndex = lastIndex + 1;		lastIndex = string.find(str, ";", nextIndex)		if not lastIndex then break end;		local str1 = string.sub(str, nextIndex, lastIndex - 1);		local m = string.find(str1, ",", 1);		if not m then			_err("----------------");		end;		local str2 = string.sub(str1, 1, m - 1);		local str3 = string.sub(str1, m + 1);		local key = tonumber(str2);		local value = tonumber(str3);		if not key or not value then			_err("!@#!$%%", str2, str3);		end;		self.setGetRecord[key] = value;	end;end;local formatStr = "%d,%d;"function CBaiduSystem:EncodeAwardStr()	local str = "";	for k, v in ipairs(self.setGetRecord) do		local str1 = string.format(formatStr, k, v);		str = str .. str1;	end;	return str;end;