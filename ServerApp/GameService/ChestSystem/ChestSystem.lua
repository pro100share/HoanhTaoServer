--[[功能：宝箱系统类作者：曲莹时间：2013-08-19]]_G.CChestSystem = {};function CChestSystem:new()	local obj = CSystem:new("CChestSystem");	obj.objDBQuery = nil;    --对应的数据库操作模	for i,v in pairs(CChestSystem) do		if type(v) == "function" then			obj[i] = v;		end;	end; 	return obj;end;function CChestSystem:Create(bIsChangeLine)	local objPlayer = self:GetPlayer();	if not objPlayer then		return;	end;	return true;end;function CChestSystem:Update()end;function CChestSystem:Destroy()end;function CChestSystem:SendChestAward(instId)	local objPlayer = self:GetPlayer();	if not objPlayer then		return;	end;	local itemSystem = objPlayer:GetSystem("CItemSystem");	if not itemSystem then		return;	end;	local itemInst = itemSystem:GetItem(instId);	--检测ItemInstId是否存在	if not itemInst then return end;	local itemEnumId = itemInst:GetEnumID();	if not _G.ChestConfig[itemEnumId] then		return;	end;	local awardList = {};	awardList = _G.ChestAwardConfig.ChestAwardList(objPlayer, itemEnumId);		if not itemSystem:IsEnumItemListCanAddToPacket(awardList) then		return;	end;	local costList = _G.ChestConfig[itemEnumId].tbCost;	--消耗物品	if not self:ChestCost(costList) then return end;	--删除宝箱	if not itemSystem:DelItemNumber(instId, 1, _G.ItemSysOperType.Chest) then return end;	--if not itemSystem:DelObjItem(instId, _G.ItemSysOperType.Chest) then return end;	--获得宝箱奖励	if not itemSystem:AddEnumItemListToPacket(awardList, _G.ItemSysOperType.Chest) then		_info("Send Chest Award Error", itemEnumId, objPlayer:GetRoleID());	end;	objPlayer.SendChestAwardInfoMsg{AwardList = awardList};end;--通过宝箱获得奖励消耗function CChestSystem:ChestCost(costList)	local objPlayer = self:GetPlayer();	if not objPlayer then			return;	end;	local itemSystem = objPlayer:GetSystem("CItemSystem");	local objElemSystem = objPlayer:GetSystem("CFiveElemSystem");	if not costList then		return;	end;	local dwGold = costList.dwGold;	local dwBindGold = costList.dwBindGold;	local dwMoney = costList.dwMoney;	local dwElement = costList.dwElement;	local itemList = costList.tbItemList;	if dwGold and dwGold > 0 then			if itemSystem:GetGold() < dwGold then			return;		end;	end;	if dwBindGold and dwBindGold > 0 then		if itemSystem:GetBindGold() < dwBindGold then			return;		end;	end;	if dwMoney and dwMoney > 0 then		if itemSystem:GetPacketMoney() < dwMoney then			return;		end;	end;	if dwElement and dwElement > 0 then		local uItemGold, uItemWood, uItemWater, uItemFire, uItemEarth  = objElemSystem:GetElemValue()		if dwElement > uItemGold or dwElement > uItemWood 								or dwElement > uItemWater or dwElement > uItemFire 								or dwElement > uItemEarth then			return;		end;	end;	if itemList then		for _, info in pairs(itemList) do			local dwEnumID = info.dwEnumID;			local dwNumber = info.dwNumber;			local b_IsEnough_1, n_Minus_1 = itemSystem:CheckDelEnumItemInPacketCond(dwEnumID, dwNumber);			if not b_IsEnough_1 then  _info("----ChestCost-----"); return end;		end;	end;	if dwGold and dwGold > 0 then		itemSystem:CostGold(dwGold, _G.ItemSysOperType.Chest) 	end;	if dwBindGold and dwBindGold > 0 then		itemSystem:CostBindGold(dwBindGold, _G.ItemSysOperType.Chest)	end;	--消耗dwMoney	if dwMoney and dwMoney > 0 then		itemSystem:CostPacketMoney(dwMoney, _G.ItemSysOperType.Chest)	end;	--消耗五行属性	if dwElement and dwElement > 0 then		--消耗真气		objElemSystem:ChangeAttr("dwMetalValue",-dwElement)		objElemSystem:ChangeAttr("dwWoodValue",-dwElement)		objElemSystem:ChangeAttr("dwWaterValue",-dwElement)		objElemSystem:ChangeAttr("dwFireValue",-dwElement)		objElemSystem:ChangeAttr("dwEarthValue",-dwElement)	end;	if itemList then		for _, info in pairs(itemList) do			local dwEnumID = info.dwEnumID;			local dwNumber = info.dwNumber;			itemSystem:DelEnumItemInPacket(dwEnumID, dwNumber, false, _G.ItemSysOperType.Chest);		end;	end;	return true;end;