--[[功能：权限系统类（服务器）版本：v1.0作者：郭肇义时间：2012-05-14]]_G.CAuthoritySystem = {};function CAuthoritySystem:new()	local obj = CSystem:new("CAuthoritySystem");	for index, value in pairs(CAuthoritySystem) do		if type(value) == "function" then			obj[index] = value;		end;	end;	return obj;end;----------------------------------------------------------------------------------------function CAuthoritySystem:Create()	--获取Player	local objPlayer = self:GetPlayer();	if not objPlayer then		_err("CAuthoritySystem Create Cannot get player");		return false;	end;	--初始化	self.tabAuthority = self:InitAuthority()	return true;end;function CAuthoritySystem:Destroy()end;function CAuthoritySystem:Init()	local tabInfo = self.tabAuthority or {}	tabInfo = AuthorityParseTable(tabInfo,AuthorityMsgStN)	self:GetPlayer().OnAuthorityInitMsg { TabInfo = tabInfo }end;function CAuthoritySystem:Reset()	local tabInfo = self.tabAuthority or {}	tabInfo = AuthorityParseTable(tabInfo,AuthorityMsgStN)	self:GetPlayer().OnAuthorityChangeMsg { TabInfo = tabInfo }end--------------------------------------------------------------------------------------------------------------------------------------------------接口------------------------------------------------------------------------------------------------------------------------------------------------function CAuthoritySystem:CheckAuthority(szAuthority)	if not CConfig.bIsCrossSvr then		if not self.tabAuthority then			return false;		end		local bAuthority = self.tabAuthority[szAuthority]		return bAuthority	else		return true;	end;endfunction CAuthoritySystem:GetAllAuthority()	for szAuthority,bState in pairs(self.tabAuthority) do		if not bState then			self.tabAuthority[szAuthority] = true			local objSystem = self:GetPlayer():GetSystem('CPlayerEventCenterSystem')			objSystem:DoEvent(enumPlayerEventType.EventGetAuthority,szAuthority)		end	end	self:Reset()end--------------------------------------------------------------------------------------------------------------------------------------------------响应------------------------------------------------------------------------------------------------------------------------------------------------function CAuthoritySystem:OnEventCenter(szEventName,Param1,Param2)	local bReset = false	--接受任务响应	if szEventName == 'EventAcceptTask' then		for k,v in pairs(AuthorityEventConfig[szEventName]) do			if v.dwTaskID == Param2 then				self.tabAuthority[v.szAuthority] = true				local objSystem = self:GetPlayer():GetSystem('CPlayerEventCenterSystem')				objSystem:DoEvent(enumPlayerEventType.EventGetAuthority,v.szAuthority)				bReset = true			end		end	end	--完成任务响应	if szEventName == 'EventCompleteTask' then		for k,v in pairs(AuthorityEventConfig[szEventName]) do			if v.dwTaskID == Param2 then				self.tabAuthority[v.szAuthority] = true				local objSystem = self:GetPlayer():GetSystem('CPlayerEventCenterSystem')				objSystem:DoEvent(enumPlayerEventType.EventGetAuthority,v.szAuthority)				bReset = true			end		end	end	--人物升级响应	if szEventName == 'EventLevelUp' then		for k,v in pairs(AuthorityEventConfig[szEventName]) do			if v.dwLevel <= Param2 then				if not self.tabAuthority[v.szAuthority] then					self.tabAuthority[v.szAuthority] = true					local objSystem = self:GetPlayer():GetSystem('CPlayerEventCenterSystem')					objSystem:DoEvent(enumPlayerEventType.EventGetAuthority,v.szAuthority)					bReset = true				end			end		end	end	--重置	if bReset then self:Reset() endend--------------------------------------------------------------------------------------------------------------------------------------------------私有------------------------------------------------------------------------------------------------------------------------------------------------function CAuthoritySystem:InitAuthority()	local tabAuthority = {}	for _,tabInfo in pairs(AuthorityConfig) do		tabAuthority[tabInfo.szAuthority] = tabInfo.bDefault	end	local dwLevel = self:GetPlayer():GetInfo().dwLevel	for _,tabInfo in pairs(AuthorityEventConfig['EventLevelUp']) do		if dwLevel >= tabInfo.dwLevel then			tabAuthority[tabInfo.szAuthority] = true		end	end	if not CConfig.bIsCrossSvr then		local objTaskSystem = self:GetPlayer():GetSystem('CTaskSystem')		local tabAcceptList,tabCompleteList = objTaskSystem:GetTaskList()		for _,tabInfo in pairs(AuthorityEventConfig['EventAcceptTask']) do			for dwTaskID in pairs(tabAcceptList) do				if tabInfo.dwTaskID == dwTaskID then					tabAuthority[tabInfo.szAuthority] = true				end			end			for dwTaskID in pairs(tabCompleteList) do				if tabInfo.dwTaskID == dwTaskID then					tabAuthority[tabInfo.szAuthority] = true				end			end				end			for _,tabInfo in pairs(AuthorityEventConfig['EventCompleteTask']) do			for dwTaskID in pairs(tabCompleteList) do				if tabInfo.dwTaskID == dwTaskID then					tabAuthority[tabInfo.szAuthority] = true				end			end		end	end;	return tabAuthorityend