--[[	剧情系统（服务器）	周长沙	2012-4-12--]]-------------------------------------_G.CStorySystem = {}-------------------------------------function CStorySystem:new()	local obj = CSystem:new("CStorySystem");	for i,v in pairs(CStorySystem) do		if type(v) == "function" then			obj[i] = v;		end;	end;	return obj;endfunction CStorySystem:Create()	--self.i = 0	return true;endfunction CStorySystem:Update(dwInterval)	--[[	self.i = self.i + 1	if self.i%100==0 then		print(self.i/100)	end	if self.i == 500 then		self:Start(1)	end	--]]	return trueendfunction CStorySystem:Destroy()	return trueend----------------------------------------消息接收--完成剧情function CStorySystem:StoryFinishMsg(dwStoryId)	local sysBuff = self:GetPlayer():GetSystem("CBuffSystem")	sysBuff:DeleteBuffByID(510001)	self:GetPlayer():GetSystem("CPlayerEventCenterSystem"):DoEvent(enumPlayerEventType.EventStoryFinish,1,dwStoryId);	if self.funOnStyFinish then		local res,_log = pcall(self.funOnStyFinish)		self.funOnStyFinish = nil		if not res then			-- print("Err CStorySystem:ScnFinishMsg",_log)		end	endend--消息发送--开始剧情function CStorySystem:StoryStartMsg(dwStoryId,bNoStop,funOnStyFinish)	local objPlayer = self:GetPlayer()	if objPlayer then		if not bNoStop then			local sysBuff = objPlayer:GetSystem("CBuffSystem")			sysBuff:AddBuff(510001, 99, releaseObj)		end		objPlayer.StoryStartMsg{StoryId=dwStoryId}		self:GetPlayer():GetSystem("CPlayerEventCenterSystem"):DoEvent(enumPlayerEventType.EventStoryStart,1,dwStoryId);		self.funOnStyFinish = funOnStyFinish	endend--开始场景展示function CStorySystem:ScnStartMsg(dwStoryId,funOnFinish)	local objPlayer = self:GetPlayer()	if objPlayer then		if not bNoStop then			local sysBuff = objPlayer:GetSystem("CBuffSystem")			sysBuff:AddBuff(510001, 99, releaseObj)		end		objPlayer.StoryScnStartMsg{StoryId=dwStoryId}		self.funOnScnFinish = funOnFinish		--self:GetPlayer():GetSystem("CPlayerEventCenterSystem"):DoEvent(enumPlayerEventType.EventStoryStart,1,dwStoryId);	endend--结束场景展示function CStorySystem:ScnFinishMsg(dwStoryId)	local sysBuff = self:GetPlayer():GetSystem("CBuffSystem")	sysBuff:DeleteBuffByID(510001)	if self.funOnScnFinish then		local res,_log = pcall(self.funOnScnFinish)		self.funOnScnFinish = nil		if not res then			-- print("Err CStorySystem:ScnFinishMsg",_log)		end	endend----------------------------------------外部接口--触发某个id的剧情function CStorySystem:Start(dwStoryId,bNoStop,funOnStyFinish)	self:StoryStartMsg(dwStoryId,bNoStop,funOnStyFinish)end--触发某个id的场景镜头function CStorySystem:ScnStart(dwStoryId,funOnFinish)	self:ScnStartMsg(dwStoryId,funOnFinish)end