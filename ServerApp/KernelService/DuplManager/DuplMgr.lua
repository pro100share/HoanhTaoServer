--[[功能：全局副本管理器类型：继承于CSingle类，用来管理玩家副本版本：	v1.0	21:15 2012-7-5	create by lkj]]_G.CDuplMgr = CSingle:new();CSingleManager:AddSingle(CDuplMgr);--createfunction CDuplMgr:Create()		self:GetDuplNextID();	self:GetDuplRecordTime();	self:GetZhenLongTime();	self:GetJiFenData();	self:GetZLKing();	self:ClearZLPlan();	self:UpdateData()	return true;end;--清空珍珑副本进度function CDuplMgr:ClearZLPlan()	local Time = {dwTime = "23:59"};	local CycleType		= _G.CAlarmTaskCycleType.eDay;	local CycleTime = 1;	local RunTimes = 0;	local Param = {CDuplMgr};	local index = _G.CAlarmClock:AddTask(Time, CycleType, CycleTime, RunTimes, CDuplMgr.ZLPlanInfo, Param);end;--更新数据库function CDuplMgr:UpdateData()	local Time = {};	local CycleType		= _G.CAlarmTaskCycleType.eMinute ;	local CycleTime = 5;	local RunTimes = 0;	local Param = {CDuplMgr};	_G.CAlarmClock:AddTask(Time, CycleType, CycleTime, RunTimes, CDuplMgr.UpdatePlanData, Param);end;function CDuplMgr:UpdatePlanData()	CPlayerDBQuery:GetDBQuery():execute('update "T_Dupl_EntityId_Info" set "dwDuplEntityId" = $1', self.nextID or 0);end;function CDuplMgr:ZLPlanInfo()	CPlayerDBQuery:GetDBQuery():execute('update "T_Dupl_ZL_Boss_Record" set "hitBossInfo" = $1', "");	for i,objLine in pairs(CGameLineManager:GetAllLine()) do		objLine.UpdateZLPlanMsg{};		end;	end;--updatefunction CDuplMgr:Update(dwInterval)	return true;end;--destroyfunction CDuplMgr:Destroy()end;--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------从数据库中读出副本function CDuplMgr:GetDuplNextID()	local res = CPlayerDBQuery:GetDBQuery():execute('select "dwDuplEntityId" from "T_Dupl_EntityId_Info"');	if not res then		CPlayerDBQuery:GetDBQuery():execute('insert into "T_Dupl_EntityId_Info" values($1)', 1);		self.nextID = 0;	else		self.nextID = res[1].dwDuplEntityId	end;end;--获得下一个副本idfunction CDuplMgr:GetNextID()	self.nextID = self.nextID + 1;	return self.nextID;end;function CDuplMgr:SendDuplId(player, duplId)	local nextID = self:GetNextID();	local tbl = {};	if _G.DuplTbl[duplId] then		tbl = self:GetZLRecord();	end;	player.DuplMgr_OrderRespondMsg{OrderID = nextID, DuplId = duplId, Record = tbl};end;function CDuplMgr:SendGutDuplId(player, duplId, dwLineID, info)	local nextID = self:GetNextID();	local tbl = {};	if _G.DuplTbl[duplId] then		tbl = self:GetZLRecord();	end;	local roleId = player:GetRoleID();	local level = player:GetInfo().dwLevel;		-- for i,objLine in pairs(CGameLineManager:GetAllLine()) do		-- if objLine:ISCanCreateDulp() then			-- objLine.CreateDuplInfoMsg{OrderID = nextID, DuplId = duplId, RoleId = roleId, Level = level, Line = objLine.dwLineID, Info = info};				-- return;		-- end;	-- end;		local objLine = self:FindMinLine()	if objLine then		objLine.CreateDuplInfoMsg{OrderID = nextID, DuplId = duplId, RoleId = roleId, Level = level, Line = objLine.dwLineID, Info = info};		_info("create dupl by dupLine!!",objLine.dwLineID);		return;	end		local objMyLine = CGameLineManager:GetLine(dwLineID);	if objMyLine then		objMyLine.CreateDuplInfoMsg{OrderID = nextID, DuplId = duplId, RoleId = roleId, Level = level, Line = objMyLine.dwLineID, Info = info};		_info("create dupl by MyLine!!",objMyLine.dwLineID);	endend;function CDuplMgr:FindMinLine()	local tbLineID = {};		for i,objLine in pairs(CGameLineManager:GetAllLine()) do		if objLine:ISCanCreateDulp() then			tbLineID[i] = objLine;		end;	end;		local objMinRoleLine = nil;	for i,objLine in pairs(tbLineID)do		if objMinRoleLine then			if objLine:GetCurCount() < objMinRoleLine:GetCurCount() then				objMinRoleLine = objLine;			end		else			objMinRoleLine = objLine;		end	end		return objMinRoleLine;end;--获得最短副本结束时间function CDuplMgr:GetDuplRecordTime()	local tbl = {}	for duplId, info in pairs(DuplConfig) do		local res = CPlayerDBQuery:GetDBQuery():execute('select * from "T_Dupl_Record_Info" where "duplId" = $1', duplId);		if res then			local duplId = duplId;			local roleId = res[1].roleId;			local lifeTime = res[1].lifeTime;			local roleName = res[1].roleName;			local iconId = res[1].iconId;			if tbl[duplId] then				tbl[duplId] = {roleId, lifeTime, roleName, iconId}			else				tbl[duplId] = {}				tbl[duplId] = {roleId, lifeTime, roleName, iconId}			end;		else			CPlayerDBQuery:GetDBQuery():execute('insert into "T_Dupl_Record_Info" ("duplId", "roleId", "roleName") values($1, $2, $3)', duplId, 0, "");			local duplId = duplId;			local roleId = 0;			local lifeTime = 0;			local roleName = "";			local iconId = 0;			tbl[duplId] = {roleId, lifeTime, roleName, iconId}		end;	end;	return tbl;end;--珍珑棋局的记录function CDuplMgr:GetZhenLongTime()	self.ZLRecordInfo = {};	for i = 1, _G.ZhenLongBoss do		local res = CPlayerDBQuery:GetDBQuery():execute('select * from "T_Dupl_ZL_Record" where "waveId" = $1', i);		if res then			local waveId = i;			local roleId = res[1].roleId;			local roleName = res[1].roleName;			local costTime = res[1].times;			if self.ZLRecordInfo[waveId] then				self.ZLRecordInfo[waveId] = {roleId, roleName, costTime};			else				self.ZLRecordInfo[waveId] = {};				self.ZLRecordInfo[waveId] = {roleId, roleName, costTime};			end;		else			CPlayerDBQuery:GetDBQuery():execute('insert into "T_Dupl_ZL_Record" ("waveId") values($1)', i);			local waveId = i;			local roleId = 0;			local roleName = "";			local costTime = 0;			self.ZLRecordInfo[waveId] = {roleId, roleName, costTime}		end;	end;		return self.ZLRecordInfo;end;--获得珍珑之王function CDuplMgr:GetZLKing()	self.ZLKingTbl = {};	self.ZLKingWaveId = 0;	local res = CPlayerDBQuery:GetDBQuery():execute('select "waveId", "roleId", "roleName", "iconId" FROM "public"."T_Dupl_ZL_Record" where "times" > 0 order by "waveId" desc limit 1');	if res then		local roleId = res[1].roleId;		local roleName = res[1].roleName;		local waveId = res[1].waveId;		local iconId = res[1].iconId;		self.ZLKingTbl[waveId] = {roleId, roleName, iconId};		self.ZLKingWaveId = waveId;	else		self.ZLKingTbl[0] = {0, "", 0};	end;	return self.ZLKingTbl;end;function CDuplMgr:GetZLRecord()	return self.ZLRecordInfo;end;--获得珍珑之王记录function CDuplMgr:GetZLKingTbl()	return self.ZLKingTbl;end;--修改记录并同步function CDuplMgr:ChgRecordInfo(duplId, roleId, lifeTime, roleName, iconId)	CPlayerDBQuery:GetDBQuery():execute('update "T_Dupl_Record_Info" set "roleId" = $1, "lifeTime" = $2, "roleName" = $3, "iconId" = $4 where "duplId" = $5', roleId, lifeTime, roleName, iconId, duplId);	local info = self:GetDuplRecordTime();	info[duplId] = {roleId, lifeTime, iconId};	for i,objLine in pairs(CGameLineManager:GetAllLine()) do		objLine.ChgDuplRecordMsg{DuplId = duplId, RoleId = roleId, LifeTime = lifeTime, RoleName = roleName, IconId = iconId};		end;	end;function CDuplMgr:ChgZLRecordInfo(waveId, roleId, roleName, liveTime, iconId)	if self.ZLRecordInfo[waveId] then		if waveId > self.ZLKingWaveId then			self.ZLKingTbl[waveId] = {roleId, roleName, iconId}			for i,objLine in pairs(CGameLineManager:GetAllLine()) do				objLine.ChgZLKingInfoMsg{ZLKingInfo = self.ZLKingTbl};				end;		end;		if self.ZLRecordInfo[waveId][3] == 0 then			self.ZLRecordInfo[waveId] = {roleId, roleName, liveTime};						CPlayerDBQuery:GetDBQuery():execute('update "T_Dupl_ZL_Record" set "roleId" = $1, "roleName" = $2, "times" = $3, "iconId" = $4 where "waveId" = $5', roleId, roleName, liveTime, iconId, waveId);		else			if self.ZLRecordInfo[waveId][3] > liveTime then				self.ZLRecordInfo[waveId] = {roleId, roleName, liveTime};				if waveId == self.ZLKingWaveId then					self.ZLKingTbl[waveId] = {roleId, roleName, iconId}					for i,objLine in pairs(CGameLineManager:GetAllLine()) do						objLine.ChgZLKingInfoMsg{ZLKingInfo = self.ZLKingTbl};						end;				end;				CPlayerDBQuery:GetDBQuery():execute('update "T_Dupl_ZL_Record" set "roleId" = $1, "roleName" = $2, "times" = $3, "iconId" = $4  where "waveId" = $5', roleId, roleName, liveTime, iconId, waveId);			end;		end;	end;end;--初始化积分表function CDuplMgr:GetJiFenData()	self.JiFenInfo = {};	for duplId, info in pairs(_G.DuplConfig) do		if info.dwShowJiFen and info.dwShowJiFen == 1 then			if not self.JiFenInfo[duplId] then				self.JiFenInfo[duplId] = {};			end;			local res = CPlayerDBQuery:GetDBQuery():execute('SELECT "dwRoleId", "dwScore", "szRoleName" FROM "public"."T_Dupl_JiFen_Info" where "dwDuplId" = $1 order by "dwScore" desc limit 10', duplId);			if res then				for key, resInfo in ipairs(res) do					table.insert(self.JiFenInfo[duplId], {resInfo.dwRoleId, resInfo.dwScore, resInfo.szRoleName});				end;			end;		end;	end;end;function CDuplMgr:GetJiFenInfo()	return self.JiFenInfoend;--更新积分表function CDuplMgr:ChgJiFenInfo(duplId, roleId, score, szRoleName)	local inList = false;	if self.JiFenInfo[duplId] then		if #(self.JiFenInfo[duplId]) < 10 then			local flag = false;			for _, info in pairs(self.JiFenInfo[duplId]) do				if info[1] and roleId == info[1] then					if score > info[2] then						info[2] = score;						flag = true;						inList = true;						break;					end;				end;			end;			if not flag then				inList = true;				table.insert(self.JiFenInfo[duplId], {roleId, score, szRoleName});			end;		else			for _, info in pairs(self.JiFenInfo[duplId]) do				if roleId == info[1] then					if score > info[2] then						info[2] = score;						inList = true;						break;					end;				end;			end;			if not inList then				local len = #(self.JiFenInfo[duplId]);				if score > self.JiFenInfo[duplId][len][2] then					table.remove(self.JiFenInfo[duplId], len);					table.insert(self.JiFenInfo[duplId], {roleId, score, szRoleName});					inList = true;				end;			end;		end;		if inList then			table.sort(self.JiFenInfo[duplId], function(a, b) return a[2] > b[2] end);			for i,objLine in pairs(CGameLineManager:GetAllLine()) do				objLine.ChgJiFenInfoMsg{JiFenTbl = self.JiFenInfo, DuplId = duplId};				end;		end;	end;end;