--藏宝图道具--给看的_G.ItemTreasureMapID = {5600010,5600020,5600030,5600040}_G.Mine_News = {}--判断道具ID是否是藏宝图local rightidset = {	[5600010] = true;	[5600020] = true;	[5600030] = true;	[5600040] = true;};function Mine_News:IsRightID(enumid)	return rightidset[enumid];end;--客户端配置_G.UIItemTreasureMapConfig = {	--公告玩家颜色	szRoleNameColor = '#00FF00',	--szHtmlColor = '#00FF00',	--坐标数	dwPosNum = 3,	--坐标格式	szPos = _G.SysStringConfigInfo[4000110011]; 	--打开模式(nil：无法使用；0：直接使用；其他：读条时间(单位：毫秒))	model = 0,	--挖宝动作	dwActionID = 14,	--挖宝进度条显示	szActionBarText = T'挖宝中',	--挖宝时间	dwActionTime = 2000,	--空余格子	dwEmptySlotNum = 3,		--dwflyTime飞行时间（秒）    dwIntervalTime前后间隔（毫秒）	tFly = {dwflyTime = 2,dwIntervalTime = 500},	--经验奖励系数	Exp = {1.05,1.5,2.6};	--真气奖励系数	ZhenQi = {0,1.65,3.3};};--藏宝图文字图片function _G.Mine_News.Image(Quality)	return "CangBaoTuBiaoTi.png"end--藏宝图奖励图片_G.Mine_News.Icon = {	Exp = "Qita_exp.png",	WuXing = "Qita_zhenqi.png"}--藏宝图合成NPC_G.Mine_News.ComposeNpc = { MapID = 1002, Pos = { x = 3, y = 24 } }--藏宝图副本NPC_G.Mine_News.DuplNpc = { MapID = 1002, Pos = { x = 5, y = 19 } }--藏宝图物品奖励--藏宝图物品奖励_G.Mine_News.Show = {	[0] = {5910003,5930004,5920001,3900020,4100140,4100080,2500090,4100120,5500020,2400110,5910003,5930004,5920001,3900020,4100140,4100080,2500090,4100120,5500020,2400110};	[1] = {5910003,5930004,5920001,3900020,4100140,4100080,2500090,4100120,5500020,2400110,5910003,5930004,5920001,3900020,4100140,4100080,2500090,4100120,5500020,2400110};	[2] = {5600040,5930006,4100290,5910003,5930005,5920002,4100210,4100120,4100080,5500020,5600040,5930006,4100290,5910003,5930005,5920002,4100210,4100120,4100080,5500020};	[3] = {2400140,5930006,5940006,5500630,5500380,5930005,5930006,5500370,5910005,5600040,2400140,5930006,5940006,5500630,5500380,5930005,5930006,5500370,5910005,5600040};};--贵重物品定义填写后挖到物品播放系统公告_G.Mine_News.Values = {2400120,3900030,3900040,5930005,5930006,5940005,5940006,5600040,4100290,4100210};--三倍经验丹	2400120--藏宝图紫色	5600040--宝石4	3900040--宝石3	3900030--100W经验	5930005--500W经验	5930006--真气丹药10000	5940006--真气丹药5000	5940005--剑气石	4100290--精铁锭	4100210--事件权重--1物品 2怪物 3经验 4真气_G.Mine_News.Weight = {{100000,1,5000,5000};{10000,2,5000,5000};{10000,10,5000,5000};{10000,100,5000,5000};};--计算等级段function Mine_News:levelBelong(level)	--用四舍五入计算出玩家所属等级段	local category = 10;	--计算等级段	local category = math.floor((level+1)/10)*10;	if (category >= 80) then		category = 80;	elseif (category <= 10) then		category = 10;	end	return category;endfunction Mine_News:Churn(data)	local CC = {};	local A = {};	CC = data;		while (#CC > 0) do		local G = math.random(1,#CC);		A[(#A+1)] = CC[G]		table.remove(CC,G)		if (#CC == 0) then			break		end	end		local pack = {};	for loop = 1,3 do		pack[loop] = A[loop]	end	return pack;end--选中宝藏场景function Mine_News:MineMap(level,quality)	local t = _G.Mine_News.MapLevel	local level = Mine_News:levelBelong(level)	local Fit = {}; 	local Fit1 = {}; 	for k,n in pairs(t.Rule) do		if (level >= k) then			for k,n in pairs(n) do				Fit[#Fit+1] = n			end		end	end		for k,n in pairs(t.Special) do		if (level >= k) then			for k,n in pairs(n) do				Fit1[#Fit1+1] = n			end		end	end		local MapId = {};		for loop = 1,5 do		MapId[loop] = Fit[math.random(1,#Fit)]	end		for loop = 1,2 do		MapId[#MapId+1] = Fit1[math.random(1,#Fit1)]	end		local pack = Mine_News:Churn(MapId)	return pack;end--反馈坐标信息function Mine_News:Coordinate(level,quality)	local t = _G.Mine_News.Coordinate_Library		local MapID = Mine_News:MineMap(level,quality)	local pack = {};	local dwMapIDIndex = 1;	while true do		--地图ID		local Map = MapID[dwMapIDIndex]		--没有地图ID跳出		if not Map then break; end;				--随机key		local site = math.random(1,#t[Map]);		--判断是否重复		local bContinue = false;		for _,v in pairs(pack) do			if v.dwRecord == site then bContinue = true; end;		end		--重复跳过		if not bContinue then			--添加元素			local tData = {}			for k,v in pairs(t[Map][site]) do				tData[k] = v;			end			tData.dwMap = Map;			tData.dwRecord = site;						table.insert(pack,tData);			dwMapIDIndex = dwMapIDIndex + 1;		end		if #pack >= 3 then			break;		end	end	return pack;end--判定触发事件function Mine_News:Reward(Player,ItemQuality)	if not Player then		return;	end	--获得等级段	local Level =  Mine_News:levelBelong(Player:GetLevel())	--奖励五行	Mine_News:WuXing(Player,ItemQuality,Level)	--奖励经验	Mine_News:Exp(Player,ItemQuality,Level)		--随机物品或怪物	local t = _G.Mine_News.Weight[ItemQuality+1]	local Weight = 0;	for Loop = 1,2 do		local Unit = t[Loop]		Weight = Weight + Unit		t[Loop+4] = Weight;	end	local Rand = math.random(Weight)		if (Rand <= t[5]) then		--奖励物品		return Mine_News:Goods(Player,ItemQuality,Level)	elseif (Rand <= t[6]) then		--奖励怪物		return Mine_News:Goblin(Player,ItemQuality,Level)	endend--掉落事件function Mine_News:Goods(Player,ItemQuality,Level)	local Drawing = {	--蓝色宝图掉落	[2] = {931101,931102,931103,931104};	--紫色宝图掉落	[3] = {932201,932202,932203,932204};	};	local Level = Player:GetLevel()	local XiShu = 1;	--计算等级系数	if (Level <= 19) then		XiShu = 1;	elseif (Level <= 39) then		XiShu = 2;	elseif (Level <= 59) then		XiShu = 3;	elseif (Level >= 60) then		XiShu = 4;	end	--绿色宝图	local Goods = 5600020		if (ItemQuality >= 2) then		Goods = Drawing[ItemQuality][XiShu]	end	--重复调用次数	local Loop = Mine_News:Repeat(ItemQuality)		return Goods,Loopend--宝图掉落包调用次数function Mine_News:Repeat(ItemQuality)	local Weight = {		[1] = {5500,2000,1300,900,300};		[2] = {6000,2100,1000,700,200};		[3]	= {7000,1600,800,450,150};	};	local Rand = math.random(10000)		local a = Weight[ItemQuality]		local loop = 1;		if (Rand <= a[1]) then		loop = 1;	elseif (Rand <=(a[1]+a[2])) then		loop = 2;	elseif (Rand <=(a[1]+a[2]+a[3])) then			loop = 3;	elseif (Rand <=(a[1]+a[2]+a[3]+a[4])) then				loop = 4;	end	return loop;end--怪物事件执行function Mine_News:Goblin(Player,ItemQuality,Level)	local mpa,x,y = Player:GetSystem("CScriptSystem"):GetMapPos()	local Rand = math.random(1,#_G.Mine_News.MonsterDeploy)	--BOSS	local Boss = _G.Mine_News.MonsterDeploy[Rand]	--获取Map名称	local MapName = MapInfoConfig[mpa].szName	local GuaiWuName = MonsterDataConfig[Boss.MonsterId].name	local WanJia = Player:GetName()	CScriptManager:AddMonToMap(mpa,Boss.MonsterId,Boss.FightId,Boss.AiId,Boss.DropId,Boss.Look,x,y)	CScriptManager:Notice(string.format(SysStringConfigInfo[80],WanJia,MapName,GuaiWuName),7,false,dwMapId,30)end--经验奖励公式function Mine_News:ExpAward(ItemQuality,Level)	local t = UIItemTreasureMapConfig.Exp	local XiShu = t[ItemQuality];	local dwExp = math.floor(_G.RoleUpLevelConfig[Level].dwTaskExpHuan * XiShu);	return dwExp;end--真气奖励公式function Mine_News:WuXingAward(ItemQuality,Level)	local t = UIItemTreasureMapConfig.ZhenQi	local XiShu = t[ItemQuality];	local reward = math.floor((260+Level/4*10)*XiShu)	return reward;end--经验事件function Mine_News:Exp(objPlayer,ItemQuality,Level)	local dwExp = Mine_News:ExpAward(ItemQuality,Level)	objPlayer:AddExp(dwExp)end--五行真气事件function Mine_News:WuXing(objPlayer,ItemQuality,Level)	local reward = Mine_News:WuXingAward(ItemQuality,Level)	local bUse = false;	local dwError = 0;	    local isMetalFull = false;	local isWaterFull = false;	local isWoodFull = false;	local isEarthFull = false;	local isFireFull = false;		objPlayer:GetSystem('CFiveElemSystem'):FiveElementRecord(reward, reward, reward, reward, reward, _G.FiveElemSysOperType.ChgFiveByUseItem)	--金	if objPlayer:GetSystem('CFiveElemSystem'):ChangeAttr("dwMetalValue", reward) then		bUse = true;	else		--dwError = 6000610021;		isMetalFull = true;	end;	--木	if objPlayer:GetSystem('CFiveElemSystem'):ChangeAttr("dwWoodValue", reward) then		bUse = true;	else		--dwError = 6000610022;		isWoodFull = true;	end;	--水	if objPlayer:GetSystem('CFiveElemSystem'):ChangeAttr("dwWaterValue", reward) then		bUse = true;	else		--dwError = 6000610023;		isWaterFull = true;	end;	--火	if objPlayer:GetSystem('CFiveElemSystem'):ChangeAttr("dwFireValue", reward) then		bUse = true;	else		--dwError = 6000610024;		isFireFull = true;	end;	--土	if objPlayer:GetSystem('CFiveElemSystem'):ChangeAttr("dwEarthValue", reward) then		bUse = true;	else		--dwError = 6000610025;		isEarthFull = true;	end;			if bUse then		return;	end		if isEarthFull and isFireFull and isMetalFull and isWaterFull and isWoodFull then		return 3000410030;	end		if isEarthFull then		return 6000610025;	end	if isFireFull then		return 6000610024;	end	if isMetalFull then		return 6000610021;	end	if isWaterFull then		return 6000610023	end	if isWoodFull then		return 6000610022	endend